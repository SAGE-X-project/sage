# SAGE Code Review Checklist

**Last Updated**: 2025-10-10
**Version**: 1.0

이 체크리스트는 SAGE 프로젝트의 코드 리뷰 시 확인해야 할 항목들을 정리한 문서입니다.

---

## 📋 일반 사항

### 코드 품질
- [ ] 코드가 명확하고 읽기 쉬운가?
- [ ] 변수/함수명이 의미를 잘 전달하는가?
- [ ] 불필요한 주석이 없는가? (코드 자체가 설명적인가?)
- [ ] 복잡한 로직에 적절한 주석이 있는가?
- [ ] 매직 넘버가 상수로 정의되어 있는가?

### 아키텍처
- [ ] 단일 책임 원칙을 따르는가?
- [ ] 적절한 추상화 레벨인가?
- [ ] 불필요한 의존성이 없는가?
- [ ] 패키지 구조가 논리적인가?

---

##  타입 안전성

### interface{} 사용
- [ ] `interface{}` 사용에 정당한 이유가 있는가?
- [ ] 구체적인 타입으로 대체 가능한가?
- [ ] 타입별 메서드 분리를 고려했는가?
- [ ] Go 1.18+ 제네릭 사용을 고려했는가?

### 타입 어설션
- [ ] **모든 타입 어설션에 comma-ok 패턴을 사용하는가?**
  ```go
  //  GOOD
  pub, ok := key.(ed25519.PublicKey)
  if !ok {
      return fmt.Errorf("expected ed25519.PublicKey, got %T", key)
  }

  //  BAD
  pub := key.(ed25519.PublicKey)  // panic 위험!
  ```

- [ ] 타입 스위치에서 default 케이스를 처리하는가?
- [ ] 에러 메시지에 실제 타입 정보(`%T`)를 포함하는가?

### 키 처리
- [ ] 서명 키와 암호화 키를 명확히 구분하는가?
- [ ] Resolver에서 적절한 메서드(`ResolvePublicKey` vs `ResolveKEMKey`)를 호출하는가?
- [ ] Ed25519 키와 X25519 키 용도가 올바른가?

---

##  에러 핸들링

### 에러 처리
- [ ] 모든 에러를 적절히 처리하는가?
- [ ] 에러 무시가 필요한 경우 `_`를 명시적으로 사용하는가?
- [ ] 에러를 래핑하여 컨텍스트를 제공하는가? (`fmt.Errorf(..., %w, err)`)
- [ ] 에러 메시지가 충분히 구체적인가?

### 에러 메시지
- [ ] 문제의 원인을 명확히 설명하는가?
- [ ] 디버깅에 필요한 정보(DID, 키 타입 등)를 포함하는가?
- [ ] 사용자에게 노출되어도 안전한가? (민감 정보 없음)

### 커스텀 에러
- [ ] 에러 타입이 적절한가?
- [ ] sentinel 에러를 적절히 사용하는가?
- [ ] `errors.Is()` / `errors.As()` 패턴을 사용하는가?

---

## 🧪 테스트

### 테스트 커버리지
- [ ] 새로운 코드에 대한 테스트가 있는가?
- [ ] 주요 경로(happy path)를 테스트하는가?
- [ ] 에러 케이스를 테스트하는가?
- [ ] 엣지 케이스를 다루는가?

### 테스트 품질
- [ ] 테스트가 독립적인가? (순서 의존성 없음)
- [ ] 테스트 데이터가 명확한가?
- [ ] 테스트 실패 시 원인을 쉽게 파악할 수 있는가?
- [ ] 테이블 기반 테스트를 적절히 사용하는가?

### 특정 케이스
- [ ] 타입 어설션 실패 케이스를 테스트하는가?
- [ ] nil 입력을 테스트하는가?
- [ ] 잘못된 타입 입력을 테스트하는가?
- [ ] 타임아웃/컨텍스트 취소를 테스트하는가?

---

## 🔐 보안

### 암호화
- [ ] 키 생성에 적절한 난수 생성기를 사용하는가? (`crypto/rand`)
- [ ] 키 크기가 적절한가? (Ed25519: 32B, X25519: 32B)
- [ ] 민감한 데이터를 로그에 출력하지 않는가?
- [ ] 메모리에서 민감 데이터를 적절히 제거하는가?

### 입력 검증
- [ ] 모든 외부 입력을 검증하는가?
- [ ] 크기 제한을 확인하는가?
- [ ] 형식을 검증하는가? (DID, base64 등)
- [ ] SQL 인젝션/커맨드 인젝션 가능성이 없는가?

### HPKE/세션
- [ ] Nonce 재사용을 방지하는가?
- [ ] 재생 공격(replay attack)을 방지하는가?
- [ ] 세션 타임아웃이 적절한가?
- [ ] 키 확인(key confirmation)을 수행하는가?

---

##  성능

### 효율성
- [ ] 불필요한 메모리 할당이 없는가?
- [ ] 반복문에서 불변 값을 반복 계산하지 않는가?
- [ ] 적절한 버퍼 크기를 사용하는가?
- [ ] defer 사용이 적절한가? (성능 critical 경로 제외)

### 동시성
- [ ] Race condition 가능성이 없는가?
- [ ] 적절한 동기화 메커니즘을 사용하는가? (mutex, channel)
- [ ] Goroutine 누수가 없는가?
- [ ] Context를 적절히 전파하는가?

### 리소스 관리
- [ ] 파일/연결을 적절히 닫는가? (`defer Close()`)
- [ ] 타이머/티커를 정리하는가?
- [ ] 메모리 누수 가능성이 없는가?

---

##  문서화

### 코드 문서
- [ ] 공개 함수/타입에 godoc 주석이 있는가?
- [ ] 복잡한 알고리즘에 설명이 있는가?
- [ ] 사용 예제가 제공되는가?
- [ ] 제약사항/가정이 문서화되어 있는가?

### API 문서
- [ ] 매개변수 요구사항이 명확한가?
- [ ] 반환값의 의미가 명확한가?
- [ ] 발생 가능한 에러가 문서화되어 있는가?
- [ ] 타입 정보가 정확한가? (특히 `interface{}` 사용 시)

---

##  Git & 변경사항

### 커밋
- [ ] 커밋 메시지가 변경 내용을 명확히 설명하는가?
- [ ] 커밋이 논리적 단위로 분리되어 있는가?
- [ ] 불필요한 파일이 포함되지 않았는가?
- [ ] `.gitignore`가 적절히 설정되어 있는가?

### PR/변경사항
- [ ] PR 설명이 충분한가?
- [ ] 관련 이슈가 링크되어 있는가?
- [ ] Breaking change가 명시되어 있는가?
- [ ] 마이그레이션 가이드가 필요한가?

---

##  SAGE 프로젝트 특화 체크리스트

### DID & Resolver
- [ ] DID 형식이 올바른가? (`did:sage:chain:identifier`)
- [ ] Resolver가 올바른 키 타입을 반환하는가?
  - `ResolvePublicKey()` → Ed25519 (서명 검증용)
  - `ResolveKEMKey()` → X25519 (HPKE 암호화용)
- [ ] DID 검증 로직이 있는가?
- [ ] Metadata 서명 검증을 수행하는가?

### HPKE
- [ ] Info 파라미터가 올바르게 구성되는가?
- [ ] Export context가 적절한가?
- [ ] Sender와 Receiver의 역할이 명확한가?
- [ ] 키 확인(ACK tag)을 검증하는가?

### RFC 9421 HTTP Signatures
- [ ] 서명에 필요한 컴포넌트가 포함되는가?
  - `@method`, `@path`, `content-digest`, `date`, `@authority`
- [ ] Nonce를 사용하여 재생 공격을 방지하는가?
- [ ] 타임스탬프 윈도우를 확인하는가?
- [ ] Content-Digest를 검증하는가?

### Session Management
- [ ] 세션 ID 생성이 안전한가?
- [ ] Key ID 바인딩이 올바른가?
- [ ] 세션 만료를 처리하는가?
- [ ] Idle timeout이 적절한가?

### Smart Contract 연동
- [ ] ABI 인코딩/디코딩이 올바른가?
- [ ] Gas 추정이 적절한가?
- [ ] 트랜잭션 에러를 처리하는가?
- [ ] 이벤트 로그를 적절히 파싱하는가?

---

##  알려진 이슈 패턴

### 타입 어설션 버그 (HPKE Fix)
HPKE 버그로부터 배운 교훈:

```go
//  BEFORE: 잘못된 패턴
pub, _ := resolver.ResolvePublicKey(ctx, serverDID)
sigKey := pub.(ed25519.PublicKey)  // 실제로는 *ecdh.PublicKey 반환!

//  AFTER: 올바른 패턴
// 1. 목적별로 메서드 분리
kemKey, err := resolver.ResolveKEMKey(ctx, serverDID)
if err != nil {
    return fmt.Errorf("failed to resolve KEM key: %w", err)
}

// 2. 안전한 타입 어설션
pub, ok := kemKey.(*ecdh.PublicKey)
if !ok {
    return fmt.Errorf("expected *ecdh.PublicKey for HPKE, got %T", kemKey)
}
```

**체크 포인트:**
- [ ] Resolver 메서드 용도가 명확한가?
- [ ] 키 타입과 용도가 일치하는가?
- [ ] 타입 어설션에 comma-ok 패턴을 사용하는가?

---

##  리뷰 프로세스

### 셀프 리뷰
PR 제출 전 스스로 체크:
1. [ ] 모든 테스트가 통과하는가?
2. [ ] 린터 경고가 없는가?
3. [ ] 불필요한 변경이 없는가?
4. [ ] 문서가 업데이트되었는가?
5. [ ] Breaking change를 명시했는가?

### 리뷰어 체크
1. [ ] 변경 범위가 적절한가? (너무 크지 않은가?)
2. [ ] 테스트가 충분한가?
3. [ ] 보안 이슈가 없는가?
4. [ ] 성능 문제가 없는가?
5. [ ] 문서가 정확한가?

### 승인 기준
- [ ] 최소 1명의 승인
- [ ] CI/CD 통과
- [ ] 체크리스트 주요 항목 통과
- [ ] 보안 관련 변경은 추가 리뷰 필요

---

##  참고 자료

- [SAGE Coding Guidelines](./CODING_GUIDELINES.md)
- [Go Code Review Comments](https://github.com/golang/go/wiki/CodeReviewComments)
- [Effective Go](https://golang.org/doc/effective_go)
- [SAGE HPKE Bug Fix](https://github.com/sage-x-project/sage/commit/9cba982)

---

##  체크리스트 사용 방법

### PR 작성자
1. PR 설명에 이 체크리스트 복사
2. 해당하는 항목 체크
3. 해당하지 않는 항목은 N/A 표시
4. 특이사항 메모

### 리뷰어
1. 체크리스트 항목 확인
2. 문제 발견 시 코멘트
3. 모든 항목 통과 시 승인
4. 개선 제안은 별도 이슈로 생성

---

**체크리스트 히스토리:**
- 2025-10-10: v1.0 초기 작성 (HPKE 타입 어설션 버그 교훈 반영)
