# SAGE ν”„λ΅μ νΈ μƒμ„Έ κ°€μ΄λ“ - Part 1: ν”„λ΅μ νΈ κ°μ” λ° μ•„ν‚¤ν…μ²

> **λ€μƒ λ…μ**: ν”„λ΅κ·Έλλ° μ΄κΈ‰μλ¶€ν„° μ¤‘κΈ‰ κ°λ°μκΉμ§€
> **μ‘μ„±μΌ**: 2025-10-07
> **λ²„μ „**: 1.0

---

## λ©μ°¨
1. [SAGEλ€ λ¬΄μ—‡μΈκ°€?](#1-sageλ€-λ¬΄μ—‡μΈκ°€)
2. [μ™ SAGEκ°€ ν•„μ”ν•κ°€?](#2-μ™-sageκ°€-ν•„μ”ν•κ°€)
3. [μ „μ²΄ μ•„ν‚¤ν…μ² κ°μ”](#3-μ „μ²΄-μ•„ν‚¤ν…μ²-κ°μ”)
4. [ν•µμ‹¬ κ°λ… μ„¤λ…](#4-ν•µμ‹¬-κ°λ…-μ„¤λ…)
5. [ν”„λ΅μ νΈ κµ¬μ΅° μƒμ„Έ λ¶„μ„](#5-ν”„λ΅μ νΈ-κµ¬μ΅°-μƒμ„Έ-λ¶„μ„)

---

## 1. SAGEλ€ λ¬΄μ—‡μΈκ°€?

### 1.1 ν”„λ΅μ νΈ μ •μ

**SAGE (Secure Agent Guarantee Engine)**λ” AI μ—μ΄μ „νΈλ“¤μ΄ μ„λ΅ μ•μ „ν•κ² ν†µμ‹ ν•  μ μλ„λ΅ ν•΄μ£Όλ” λΈ”λ΅μ²΄μΈ κΈ°λ° λ³΄μ• ν”„λ μ„μ›ν¬μ…λ‹λ‹¤.

#### μ‰¬μ΄ λΉ„μ λ΅ μ΄ν•΄ν•κΈ°

μΌλ°μ μΈ μ΄λ©”μΌ μ‹μ¤ν…μ„ μƒκ°ν•΄λ΄…μ‹λ‹¤:
- μ΄λ©”μΌμ„ λ³΄λ‚Ό λ• λ„κµ¬λ‚ λ‚΄ μ΄λ¦„μΌλ΅ μ΄λ©”μΌμ„ λ³΄λ‚Ό μ μμµλ‹λ‹¤
- μ΄λ©”μΌ λ‚΄μ©μ΄ μ¤‘κ°„μ— κ°€λ΅μ±„μΌ μ μμµλ‹λ‹¤
- λ°›μ€ μ΄λ©”μΌμ΄ μ •λ§ κ·Έ μ‚¬λμ΄ λ³΄λ‚Έ κ²ƒμΈμ§€ ν™•μ‹ ν•κΈ° μ–΄λ µμµλ‹λ‹¤

SAGEλ” AI μ—μ΄μ „νΈλ“¤ μ‚¬μ΄μ ν†µμ‹ μ—μ„ μ΄λ° λ¬Έμ λ“¤μ„ ν•΄κ²°ν•©λ‹λ‹¤:
- β… **μ‹ μ› λ³΄μ¦**: λΈ”λ΅μ²΄μΈμ„ ν†µν•΄ κ° AI μ—μ΄μ „νΈμ μ‹ μ›μ„ λ³΄μ¦
- β… **μ•”νΈν™”λ ν†µμ‹ **: λ©”μ‹μ§€κ°€ μ¤‘κ°„μ— κ°€λ΅μ±„μ΄λ”λΌλ„ μ½μ„ μ μ—†μ
- β… **μ„λ… κ²€μ¦**: λ©”μ‹μ§€κ°€ μ •λ§ κ·Έ μ—μ΄μ „νΈκ°€ λ³΄λ‚Έ κ²ƒμΈμ§€ κ²€μ¦ κ°€λ¥

### 1.2 ν•µμ‹¬ κΈ°λ¥

#### κΈ°λ¥ 1: μΆ…λ‹¨κ°„ μ•”νΈν™” ν•Έλ“μ…°μ΄ν¬ (End-to-End Encrypted Handshake)

**λ¬Έμ **: AI μ—μ΄μ „νΈ Aμ™€ Bκ°€ μ²μ λ§λ‚¬μ„ λ• μ–΄λ–»κ² μ•μ „ν• ν†µμ‹  μ±„λ„μ„ λ§λ“¤κΉ?

**ν•΄κ²°μ±…**: HPKE (Hybrid Public Key Encryption) κΈ°λ° ν•Έλ“μ…°μ΄ν¬
```
λ‹¨κ³„λ³„ μ„¤λ…:
1. Aκ°€ Bμ—κ² "μ•μ „ν•κ² λ€ν™”ν•κ³  μ‹¶μ–΄μ”" λΌκ³  μ΄λ€μ¥μ„ λ³΄λƒ„
2. Aμ™€ Bκ°€ κ°κ° μ„μ‹ λΉ„λ°€ ν‚¤λ¥Ό μƒμ„± (X25519 ν‚¤)
3. μ΄ μ„μ‹ ν‚¤λ“¤μ„ κµν™ν•΄μ„ κ³µμ  λΉ„λ°€μ„ λ§λ“¦
4. κ³µμ  λΉ„λ°€λ΅λ¶€ν„° μ‹¤μ  ν†µμ‹ μ— μ‚¬μ©ν•  μ•”νΈν™” ν‚¤λ¥Ό μ λ„
5. μ΄μ  μ•μ „ν• μ„Έμ…μ΄ λ§λ“¤μ–΄μ§!
```

**μ‚¬μ©λ κΈ°μ **:
- **X25519**: ν‚¤ κµν™ μ•κ³ λ¦¬μ¦ (λ§¤μ° λΉ λ¥΄κ³  μ•μ „ν•¨)
- **HPKE (RFC 9180)**: μµμ‹  ν‘μ¤€ μ•”νΈν™” ν”„λ΅ν† μ½
- **Forward Secrecy**: κ³Όκ±° λ©”μ‹μ§€κ°€ λ‚μ¤‘μ— λ…Έμ¶λμ–΄λ„ ν•΄λ… λ¶κ°€λ¥

#### κΈ°λ¥ 2: RFC 9421 μ¤€μ (HTTP λ©”μ‹μ§€ μ„λ…)

**λ¬Έμ **: HTTP μ”μ²­μ΄ μ¤‘κ°„μ— λ³€μ΅°λμ§€ μ•μ•λ‹¤λ” κ²ƒμ„ μ–΄λ–»κ² λ³΄μ¥ν•λ‚?

**ν•΄κ²°μ±…**: RFC 9421 ν‘μ¤€μ— λ”°λ¥Έ λ©”μ‹μ§€ μ„λ…
```
μμ‹:
μ›λ³Έ HTTP μ”μ²­:
POST /api/chat HTTP/1.1
Host: agent-b.example.com
Content-Type: application/json
{"message": "Hello"}

μ„λ… μƒμ„± κ³Όμ •:
1. μ¤‘μ”ν• λ¶€λ¶„λ“¤μ„ μ¶”μ¶:
   - λ©”μ„λ“: POST
   - κ²½λ΅: /api/chat
   - νΈμ¤νΈ: agent-b.example.com
   - λ‚΄μ©: {"message": "Hello"}

2. μ΄λ“¤μ„ μ •κ·ν™”λ ν•μ‹μΌλ΅ κ²°ν•©

3. κ°μΈν‚¤λ΅ μ„λ… μƒμ„±

4. μ„λ…μ„ ν—¤λ”μ— μ¶”κ°€:
   Signature: keyId="agent-a-key-123", algorithm="ed25519",
              signature="base64encodedSignature..."

5. μμ‹ μκ°€ κ³µκ°ν‚¤λ΅ μ„λ… κ²€μ¦
```

**μ‹¤μ  μ½”λ“ μ„μΉ**: `/core/rfc9421/`

#### κΈ°λ¥ 3: λ‹¤μ¤‘ μ²΄μΈ μ§€μ›

SAGEλ” μ—¬λ¬ λΈ”λ΅μ²΄μΈ λ„¤νΈμ›ν¬λ¥Ό μ§€μ›ν•©λ‹λ‹¤:

| λΈ”λ΅μ²΄μΈ | μƒνƒ | μ©λ„ |
|---------|------|------|
| **Ethereum** | β… μ™„μ „ μ§€μ› | λ©”μΈλ„· ν”„λ΅λ•μ… |
| **Sepolia** | β… ν…μ¤νΈλ„· | κ°λ° λ° ν…μ¤νΈ |
| **Kaia (Cypress)** | β… μ™„μ „ μ§€μ› | ν•κµ­ μ¤‘μ‹¬ λ„¤νΈμ›ν¬ |
| **Kairos** | β… ν…μ¤νΈλ„· | Kaia ν…μ¤νΈ ν™κ²½ |
| **Solana** | π§ κ°λ° μ¤‘ | κ³ μ„±λ¥ νΈλμ­μ… |

**μ™ μ—¬λ¬ μ²΄μΈμ„ μ§€μ›ν•λ‚?**
- λ‹¤λ¥Έ λΉ„μ©: Ethereumμ€ λΉ„μ‹Έμ§€λ§ κ°€μ¥ μ•μ „, Kaiaλ” μ €λ ΄ν•κ³  λΉ λ¦„
- λ‹¤λ¥Έ μ—μ½”μ‹μ¤ν…: κ° μ²΄μΈλ§λ‹¤ λ‹¤λ¥Έ κ°λ°μ μ»¤λ®¤λ‹ν‹°
- μ§€μ—­μ  μ„ νΈ: Kaiaλ” ν•κµ­μ—μ„ λ§μ΄ μ‚¬μ©λ¨

#### κΈ°λ¥ 4: ν–¥μƒλ λ³΄μ•

**κ³µκ°ν‚¤ μ†μ κ¶ κ²€μ¦**:
```
λ¬Έμ  μ‹λ‚λ¦¬μ¤:
μ•…μμ μΈ μ‚¬μ©μκ°€ λ‹¤λ¥Έ μ‚¬λμ κ³µκ°ν‚¤λ¥Ό μκΈ° κ²ƒμ΄λΌκ³  λ“±λ΅ν•λ ¤ ν•¨

SAGEμ ν•΄κ²°μ±…:
1. κ³µκ°ν‚¤λ¥Ό λ“±λ΅ν•  λ• "μ±λ¦°μ§€-μ‘λ‹µ" κ³Όμ • ν•„μ”
2. μ‹μ¤ν…μ΄ λλ¤ λ©”μ‹μ§€λ¥Ό μƒμ„±: "μ¦λ…ν•΄λ³΄μ„Έμ”: XYZ123"
3. μ‚¬μ©μλ” μμ‹ μ κ°μΈν‚¤λ΅ μ΄ λ©”μ‹μ§€μ— μ„λ…
4. μ‹μ¤ν…μ΄ κ³µκ°ν‚¤λ΅ μ„λ… κ²€μ¦
5. κ²€μ¦ μ„±κ³µ μ‹μ—λ§ λ“±λ΅ ν—μ©

μ½”λ“ μ„μΉ: contracts/ethereum/contracts/SageRegistryV2.sol:148-166
```

**ν‚¤ μ·¨μ† κΈ°λ¥**:
```
λ§μ•½ κ°μΈν‚¤κ°€ λ…Έμ¶λμ—λ‹¤λ©΄?
1. μ†μ μκ°€ "ν‚¤ μ·¨μ†" νΈλμ­μ… μ „μ†΅
2. μ¤λ§νΈ μ»¨νΈλ™νΈμ— μ·¨μ† κΈ°λ΅
3. μ΄ν›„ ν•΄λ‹Ή ν‚¤λ΅ μ„λ…λ λ¨λ“  λ©”μ‹μ§€ κ±°λ¶€
4. μƒ ν‚¤ μ μƒμ„± λ° μ¬λ“±λ΅

μ½”λ“ μ„μΉ: contracts/ethereum/contracts/SageRegistryV2.sol (revokeKey ν•¨μ)
```

#### κΈ°λ¥ 5: λ‹¤μ¤‘ μ•κ³ λ¦¬μ¦ μ§€μ›

SAGEλ” 3κ°€μ§€ μ•”νΈν™” μ•κ³ λ¦¬μ¦μ„ μ§€μ›ν•©λ‹λ‹¤:

**1. Ed25519 (Edwards-curve Digital Signature Algorithm)**
```
μ©λ„: λ””μ§€ν„Έ μ„λ… (μ‹ μ› ν™•μΈ)
νΉμ§•:
- λ§¤μ° λΉ λ¥Έ μ„λ…/κ²€μ¦ μ†λ„
- μ‘μ€ ν‚¤ ν¬κΈ° (32λ°”μ΄νΈ)
- λ†’μ€ λ³΄μ•μ„±

μ‚¬μ© μ:
- AI μ—μ΄μ „νΈμ μ‹ μ› μ„λ…
- DID λ¬Έμ„ μ„λ…
- λ©”μ‹μ§€ μΈμ¦

μ½”λ“ μ„μΉ: crypto/keys/ed25519.go
```

**2. Secp256k1 (Elliptic Curve)**
```
μ©λ„: Ethereumκ³Όμ νΈν™μ„±
νΉμ§•:
- Ethereumκ³Ό Bitcoinμ΄ μ‚¬μ©ν•λ” ν‘μ¤€
- ECDSA μ„λ…
- Ethereum μ£Όμ† νμƒ

μ‚¬μ© μ:
- Ethereum νΈλμ­μ… μ„λ…
- μ¤λ§νΈ μ»¨νΈλ™νΈ μƒνΈμ‘μ©
- Ethereum κ³„μ • κ΄€λ¦¬

μ½”λ“ μ„μΉ: crypto/keys/secp256k1.go
```

**3. X25519 (Curve25519)**
```
μ©λ„: ν‚¤ κµν™ (μ•”νΈν™” ν‚¤ κ³µμ )
νΉμ§•:
- μ„λ…μ΄ μ•„λ‹ ν‚¤ κµν™ μ „μ©
- Diffie-Hellman ν‚¤ κµν™
- Forward Secrecy μ κ³µ

μ‚¬μ© μ:
- ν•Έλ“μ…°μ΄ν¬ μ‹ μ„μ‹ ν‚¤ κµν™
- μ„Έμ… ν‚¤ μ λ„
- HPKE μ•”νΈν™”

μ½”λ“ μ„μΉ: crypto/keys/x25519.go
```

**μ•κ³ λ¦¬μ¦ λΉ„κµν‘**:

| κΈ°λ¥ | Ed25519 | Secp256k1 | X25519 |
|-----|---------|-----------|---------|
| **μ„λ… μƒμ„±** | β… | β… | β |
| **μ„λ… κ²€μ¦** | β… | β… | β |
| **ν‚¤ κµν™** | β | β | β… |
| **μ•”νΈν™”** | β οΈ (λ³€ν™ ν›„) | β | β… |
| **ν‚¤ ν¬κΈ°** | 32λ°”μ΄νΈ | 33/65λ°”μ΄νΈ | 32λ°”μ΄νΈ |
| **μ†λ„** | β΅ λ§¤μ° λΉ λ¦„ | π€ λΉ λ¦„ | β΅ λ§¤μ° λΉ λ¦„ |
| **Ethereum νΈν™** | β | β… | β |

---

## 2. μ™ SAGEκ°€ ν•„μ”ν•κ°€?

### 2.1 AI μ—μ΄μ „νΈ μ‹λ€μ λ³΄μ• λ¬Έμ 

**ν„μ¬ μƒν™©**:
2024-2025λ…„ ν„μ¬, AI μ—μ΄μ „νΈλ“¤μ΄ ν­λ°μ μΌλ΅ μ¦κ°€ν•κ³  μμµλ‹λ‹¤:
- ChatGPT, Claude κ°™μ€ λ€ν™”ν• AI
- μλ™ν™”λ κ±°λ λ΄‡
- μ½”λ“ μ‘μ„± μ—μ΄μ „νΈ
- λ°μ΄ν„° λ¶„μ„ μ—μ΄μ „νΈ

**λ¬Έμ μ **:
```
μ‹λ‚λ¦¬μ¤ 1: μ‹ μ› μ‚¬μΉ­
μ•…μμ μΈ μ—μ΄μ „νΈ Cκ°€ ν•©λ²•μ μΈ μ—μ΄μ „νΈ BμΈ μ²™ ν•¨
β†’ μ—μ΄μ „νΈ Aκ°€ Cμ—κ² μ¤‘μ”ν• μ •λ³΄λ¥Ό λ³΄λƒ„
β†’ μ •λ³΄ μ μ¶!

μ‹λ‚λ¦¬μ¤ 2: μ¤‘κ°„μ κ³µκ²© (Man-in-the-Middle)
μ—μ΄μ „νΈ A β†β†’ [κ³µκ²©μ] β†β†’ μ—μ΄μ „νΈ B
β†’ κ³µκ²©μκ°€ λ¨λ“  λ©”μ‹μ§€λ¥Ό κ°€λ΅μ±„κ³  μμ • κ°€λ¥

μ‹λ‚λ¦¬μ¤ 3: μ¬μƒ κ³µκ²© (Replay Attack)
κ³µκ²©μκ°€ κ³Όκ±°μ— λ³΄λ‚Έ ν•©λ²•μ μΈ λ©”μ‹μ§€λ¥Ό λ‹¤μ‹ λ³΄λƒ„
β†’ κ°™μ€ μ‘μ—…μ΄ μ—¬λ¬ λ² μ‹¤ν–‰λ¨ (μ: λ μ†΅κΈ)
```

### 2.2 SAGEμ ν•΄κ²° λ°©λ²•

#### ν•΄κ²°μ±… 1: λΈ”λ΅μ²΄μΈ κΈ°λ° μ‹ μ› κ΄€λ¦¬ (DID)

**Decentralized Identifier (DID)**:
```
κ°λ…:
- λΈ”λ΅μ²΄μΈμ— κ° AI μ—μ΄μ „νΈμ μ‹ μ› μ •λ³΄ μ €μ¥
- μ¤‘μ•™ μ„λ²„ μ—†μ΄ λ„κµ¬λ‚ κ²€μ¦ κ°€λ¥
- ν•λ² λ“±λ΅λλ©΄ λ³€μ΅° λ¶κ°€λ¥

μμ‹ DID:
did:sage:ethereum:0x1234567890abcdef...

κµ¬μ΅° μ„¤λ…:
- did: DID ν‘μ¤€ ν”„λ΅ν† μ½
- sage: SAGE μ‹μ¤ν…
- ethereum: Ethereum λΈ”λ΅μ²΄μΈ
- 0x1234...: κ³ μ  μ‹λ³„μ (Ethereum μ£Όμ†)
```

**DID λ“±λ΅ κ³Όμ •** (μ΄λ³΄μμ© μ„¤λ…):

1. **ν‚¤ μ μƒμ„±**:
```bash
# λ…λ Ήμ–΄ μ‹¤ν–‰
./sage-crypto generate -t ed25519 -o agent-key.pem

λ‚΄λ¶€ λ™μ‘:
1. λλ¤ν• 256λΉ„νΈ μ«μ μƒμ„± (κ°μΈν‚¤)
2. μν•™ κ³µμ‹μΌλ΅ κ³µκ°ν‚¤ κ³„μ‚°
3. νμΌλ΅ μ•μ „ν•κ² μ €μ¥

κ²°κ³Ό:
- agent-key.pem (κ°μΈν‚¤ - μ λ€ κ³µμ ν•λ©΄ μ•λ¨!)
- agent-key.pub (κ³µκ°ν‚¤ - κ³µκ°ν•΄λ„ λ¨)
```

2. **μ¤λ§νΈ μ»¨νΈλ™νΈμ— λ“±λ΅**:
```bash
./sage-did register \
  --chain ethereum \
  --key agent-key.pem \
  --name "My AI Agent" \
  --endpoint "https://my-agent.com/api" \
  --capabilities "chat,code,analysis"

λ‚΄λ¶€ λ™μ‘:
1. κ³µκ°ν‚¤ μ½κΈ°
2. μ†μ κ¶ μ¦λ…μ„ μ„ν• μ„λ… μƒμ„±
3. Ethereum νΈλμ­μ… μƒμ„±:
   - ν•¨μ: registerAgent()
   - νλΌλ―Έν„°: name, endpoint, publicKey, signature
4. νΈλμ­μ… μ „μ†΅ (κ°€μ¤λΉ„ μ§€λ¶)
5. λΈ”λ΅μ²΄μΈμ— μκµ¬ κΈ°λ΅

κ²°κ³Ό:
- DID μƒμ„±: did:sage:ethereum:0x...
- λ„κµ¬λ‚ μ΅°ν κ°€λ¥ν• κ³µκ° μ •λ³΄:
  * μ΄λ¦„: "My AI Agent"
  * μ—”λ“ν¬μΈνΈ: "https://my-agent.com/api"
  * κ³µκ°ν‚¤: 0x1234...
  * κΈ°λ¥: ["chat", "code", "analysis"]
```

3. **DID μ΅°ν λ° κ²€μ¦**:
```bash
./sage-did resolve did:sage:ethereum:0x...

λ‚΄λ¶€ λ™μ‘:
1. Ethereum λ…Έλ“μ— μ—°κ²°
2. μ¤λ§νΈ μ»¨νΈλ™νΈ μ½κΈ° (getAgent ν•¨μ νΈμ¶)
3. λΈ”λ΅μ²΄μΈμ—μ„ λ°μ΄ν„° κ°€μ Έμ¤κΈ°
4. JSON ν•μ‹μΌλ΅ νμ‹±

λ°ν™ λ°μ΄ν„°:
{
  "did": "did:sage:ethereum:0x...",
  "name": "My AI Agent",
  "endpoint": "https://my-agent.com/api",
  "publicKey": "0x1234...",
  "capabilities": ["chat", "code", "analysis"],
  "active": true,
  "owner": "0xOwnerAddress..."
}
```

#### ν•΄κ²°μ±… 2: μ™„λ²½ν• Forward Secrecy

**Forward Secrecyλ€?**
```
λΉ„μ :
λ§¤μΌ μƒλ΅μ΄ μλ¬Όμ‡ λ΅ λ°”κΎΈλ” μ§‘

μΌλ° μ•”νΈν™”:
ν•λ‚μ μ—΄μ‡ λ΅ λ¨λ“  λ©”μ‹μ§€ μ•”νΈν™”
β†’ μ—΄μ‡  λ…Έμ¶ μ‹ κ³Όκ±° λ©”μ‹μ§€ μ „λ¶€ λ…Έμ¶!

Forward Secrecy:
κ° μ„Έμ…λ§λ‹¤ λ‹¤λ¥Έ μ„μ‹ μ—΄μ‡  μ‚¬μ©
β†’ ν•λ‚μ μ—΄μ‡ κ°€ λ…Έμ¶λμ–΄λ„ λ‹¤λ¥Έ μ„Έμ…μ€ μ•μ „
β†’ μ„μ‹ μ—΄μ‡ λ” μ‚¬μ© ν›„ μ¦‰μ‹ νκΈ°
```

**SAGEμ κµ¬ν„**:
```
ν•Έλ“μ…°μ΄ν¬ κ³Όμ •:
1. Aκ°€ μ„μ‹ X25519 ν‚¤ μ μƒμ„±
   μ„μ‹_κ°μΈν‚¤_A, μ„μ‹_κ³µκ°ν‚¤_A

2. Bκ°€ μ„μ‹ X25519 ν‚¤ μ μƒμ„±
   μ„μ‹_κ°μΈν‚¤_B, μ„μ‹_κ³µκ°ν‚¤_B

3. μ„μ‹ κ³µκ°ν‚¤ κµν™ (μ•”νΈν™”λ μ±„λ„λ΅)

4. κ°μ κ³µμ  λΉ„λ°€ κ³„μ‚°:
   κ³µμ λΉ„λ°€ = ECDH(μ„μ‹_κ°μΈν‚¤_A, μ„μ‹_κ³µκ°ν‚¤_B)
   (Aμ™€ Bκ°€ κ°™μ€ κ²°κ³Όλ¥Ό μ–»μ!)

5. κ³µμ  λΉ„λ°€μ—μ„ μ„Έμ… ν‚¤ μ λ„:
   μ„Έμ…ν‚¤ = HKDF(κ³µμ λΉ„λ°€, "μ•”νΈν™”μ©", 32λ°”μ΄νΈ)
   μ„λ…ν‚¤ = HKDF(κ³µμ λΉ„λ°€, "μ„λ…μ©", 32λ°”μ΄νΈ)

6. ν†µμ‹  μΆ…λ£ μ‹:
   - λ¨λ“  μ„μ‹ ν‚¤ μ‚­μ 
   - μ„Έμ… ν‚¤ μ‚­μ 
   - λ©”λ¨λ¦¬μ—μ„ μ™„μ „ν μ§€μ›€ (0μΌλ΅ λ®μ–΄μ“°κΈ°)

κ²°κ³Ό:
- λ‚μ¤‘μ— κ°μΈν‚¤κ°€ λ…Έμ¶λμ–΄λ„ κ³Όκ±° μ„Έμ… λ³µνΈν™” λ¶κ°€λ¥
- κ° μ„Έμ…μ€ λ…λ¦½μ μΌλ΅ λ³΄νΈλ¨

μ½”λ“ μ„μΉ: session/session.go:355-398 (Close ν•¨μμ ν‚¤ μ‚­μ  λ΅μ§)
```

#### ν•΄κ²°μ±… 3: μ¬μƒ κ³µκ²© λ°©μ§€ (Replay Protection)

**Nonce (Number used ONCE)**:
```
κ°λ…:
- ν• λ²λ§ μ‚¬μ©λλ” μ„μμ μ«μ/λ¬Έμμ—΄
- κ°™μ€ nonceλ¥Ό κ°€μ§„ λ©”μ‹μ§€λ” κ±°λ¶€

μμ‹:
μ”μ²­ 1: {"message": "μ†΅κΈ 100λ‹¬λ¬", "nonce": "abc123"}
β†’ μ²λ¦¬λ¨

μ”μ²­ 2: {"message": "μ†΅κΈ 100λ‹¬λ¬", "nonce": "abc123"}
β†’ κ±°λ¶€! (κ°™μ€ nonce)

μ”μ²­ 3: {"message": "μ†΅κΈ 100λ‹¬λ¬", "nonce": "def456"}
β†’ μ²λ¦¬λ¨ (μƒλ΅μ΄ nonce)
```

**SAGEμ Nonce κ΄€λ¦¬**:
```go
// μ½”λ“ μ„μΉ: session/nonce.go

1. Nonce μΊμ‹ μƒμ„±:
   - κ° μ„Έμ…λ§λ‹¤ λ…λ¦½μ μΈ nonce μ €μ¥μ†
   - TTL (Time To Live) μ„¤μ • (μ: 5λ¶„)

2. λ©”μ‹μ§€ μμ‹  μ‹:
   func (nc *NonceCache) Check(nonce string) bool {
       if nc.seen[nonce] {
           return false  // μ΄λ―Έ μ‚¬μ©λ nonce
       }
       nc.seen[nonce] = time.Now()
       return true  // μ²μ λ³΄λ” nonce
   }

3. μλ™ μ²­μ†:
   - 5λ¶„λ§λ‹¤ μ¤λλ nonce μ‚­μ 
   - λ©”λ¨λ¦¬ ν¨μ¨μ„± μ μ§€

μ½”λ“ μ„μΉ: session/nonce.go:30-60
```

---

## 3. μ „μ²΄ μ•„ν‚¤ν…μ² κ°μ”

### 3.1 κ³„μΈµ κµ¬μ΅°

SAGEλ” 5κ°μ μ£Όμ” κ³„μΈµμΌλ΅ κµ¬μ„±λ©λ‹λ‹¤:

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚           Layer 5: Application Layer                     β”‚
β”‚         (AI μ—μ΄μ „νΈ μ• ν”λ¦¬μΌ€μ΄μ…)                          β”‚
β”‚                                                           β”‚
β”‚  μ: μ±—λ΄‡, κ±°λ λ΄‡, λ¶„μ„ μ—μ΄μ „νΈ                           β”‚
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¤
β”‚           Layer 4: Protocol Layer                        β”‚
β”‚         (ν•Έλ“μ…°μ΄ν¬ λ° μ„Έμ… ν”„λ΅ν† μ½)                        β”‚
β”‚                                                           β”‚
β”‚  - 4λ‹¨κ³„ ν•Έλ“μ…°μ΄ν¬                                        β”‚
β”‚  - μ„Έμ… μƒμ„± λ° κ΄€λ¦¬                                       β”‚
β”‚  - RFC 9421 λ©”μ‹μ§€ μ„λ…                                   β”‚
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¤
β”‚           Layer 3: Crypto Layer                          β”‚
β”‚         (μ•”νΈν™” λ° ν‚¤ κ΄€λ¦¬)                                β”‚
β”‚                                                           β”‚
β”‚  - Ed25519 μ„λ…                                           β”‚
β”‚  - X25519 ν‚¤ κµν™                                         β”‚
β”‚  - ChaCha20-Poly1305 μ•”νΈν™”                              β”‚
β”‚  - HKDF ν‚¤ μ λ„                                           β”‚
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¤
β”‚           Layer 2: Identity Layer                        β”‚
β”‚         (DID λ° μ‹ μ› κ΄€λ¦¬)                                β”‚
β”‚                                                           β”‚
β”‚  - DID λ“±λ΅/μ΅°ν/μ—…λ°μ΄νΈ                                  β”‚
β”‚  - κ³µκ°ν‚¤ κ²€μ¦                                            β”‚
β”‚  - λ‹¤μ¤‘ μ²΄μΈ μ§€μ›                                         β”‚
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¤
β”‚           Layer 1: Blockchain Layer                      β”‚
β”‚         (μ¤λ§νΈ μ»¨νΈλ™νΈ λ° λΈ”λ΅μ²΄μΈ)                       β”‚
β”‚                                                           β”‚
β”‚  - Ethereum: SageRegistryV2                              β”‚
β”‚  - Kaia: SageRegistry                                    β”‚
β”‚  - Solana: (κ°λ° μ¤‘)                                      β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

### 3.2 μ»΄ν¬λ„νΈ κ°„ μƒνΈμ‘μ©

**μ‹λ‚λ¦¬μ¤: AI μ—μ΄μ „νΈ Aκ°€ μ—μ΄μ „νΈ Bμ—κ² λ©”μ‹μ§€ μ „μ†΅**

```
λ‹¨κ³„λ³„ νλ¦„:

1. μ΄κΈ°ν™” λ‹¨κ³„
   β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
   β”‚ Agent A β”‚
   β””β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”
        β”‚ 1. DID μ΅°ν μ”μ²­
        β†“
   β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
   β”‚  DID Resolver   β”‚ β† Ethereum/Kaia λΈ”λ΅μ²΄μΈμ—μ„ λ°μ΄ν„° μ½κΈ°
   β””β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
        β”‚ 2. Agent Bμ κ³µκ°ν‚¤ λ° μ—”λ“ν¬μΈνΈ λ°ν™
        β†“
   β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
   β”‚ Agent A β”‚
   β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

2. ν•Έλ“μ…°μ΄ν¬ λ‹¨κ³„
   β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”                    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
   β”‚ Agent A β”‚                    β”‚ Agent B β”‚
   β””β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”                    β””β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”
        β”‚                              β”‚
        β”‚ Invitation (μ„λ…λ¨)          β”‚
        β”‚β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€>β”‚
        β”‚                              β”‚
        β”‚ Request (Bμ ν‚¤λ΅ μ•”νΈν™”)     β”‚
        β”‚β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€>β”‚
        β”‚                              β”‚
        β”‚ Response (Aμ ν‚¤λ΅ μ•”νΈν™”)    β”‚
        β”‚<β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”‚
        β”‚                              β”‚
        β”‚ Complete (μ„Έμ… ν™•μ •)          β”‚
        β”‚β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€>β”‚
        β”‚                              β”‚
        β”‚ ACK (KeyID λ°κΈ‰)             β”‚
        β”‚<β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”‚

3. λ³΄μ• ν†µμ‹  λ‹¨κ³„
   β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”                    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
   β”‚ Agent A β”‚                    β”‚ Agent B β”‚
   β””β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”                    β””β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”
        β”‚                              β”‚
        β”‚ μ„Έμ… ν‚¤λ΅ μ•”νΈν™”λ λ©”μ‹μ§€      β”‚
        β”‚ + RFC 9421 μ„λ…              β”‚
        β”‚β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€>β”‚
        β”‚                              β”‚ 1. μ„λ… κ²€μ¦
        β”‚                              β”‚ 2. λ³µνΈν™”
        β”‚                              β”‚ 3. λ©”μ‹μ§€ μ²λ¦¬
        β”‚                              β”‚
        β”‚ μ‘λ‹µ (μ•”νΈν™” + μ„λ…)          β”‚
        β”‚<β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”‚
```

---

## 4. ν•µμ‹¬ κ°λ… μ„¤λ…

### 4.1 DID (Decentralized Identifier)

**DIDλ€ λ¬΄μ—‡μΈκ°€?**

DIDλ” μ¤‘μ•™ κΈ°κ΄€ μ—†μ΄ μκΈ° μ£Όκ¶μ μΌλ΅ κ΄€λ¦¬ν•  μ μλ” λ””μ§€ν„Έ μ‹ μ›μ…λ‹λ‹¤.

**μ „ν†µμ μΈ μ‹ μ› vs DID**:

```
μ „ν†µμ μΈ μ‹ μ› (μ¤‘μ•™ν™”):
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚   μ¤‘μ•™ μ„λ²„ (μ: Facebook, Google)    β”‚
β”‚   - μ‚¬μ©μ μ •λ³΄ μ €μ¥                  β”‚
β”‚   - μ‹ μ› λ°κΈ‰ λ° κ΄€λ¦¬                 β”‚
β”‚   - μ ‘κ·Ό κ¶ν• ν†µμ                     β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
           β”‚ λ¬Έμ μ :
           β”‚ 1. μ„λ²„ ν•΄ν‚Ή μ‹ λ¨λ“  μ •λ³΄ μ μ¶
           β”‚ 2. νμ‚¬κ°€ λ§ν•λ©΄ μ‹ μ› μ‚¬λΌμ§
           β”‚ 3. κ°μΈ μ •λ³΄ ν†µμ κ¶ μ—†μ
           β†“
    [μ‚¬μ©μλ“¤...]

DID (νƒμ¤‘μ•™ν™”):
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚   λΈ”λ΅μ²΄μΈ (Ethereum, Kaia λ“±)        β”‚
β”‚   - κ³µκ°ν‚¤λ§ μ €μ¥                     β”‚
β”‚   - λ³€μ΅° λ¶κ°€λ¥                       β”‚
β”‚   - 24/7 κ°€μ©                        β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
           β”‚ μ¥μ :
           β”‚ 1. κ°μΈν‚¤ μ†μ μλ§ ν†µμ  κ°€λ¥
           β”‚ 2. μκµ¬μ μΌλ΅ μ΅΄μ¬
           β”‚ 3. κΈ€λ΅λ²ν•κ² κ²€μ¦ κ°€λ¥
           β†“
    [μ‚¬μ©μλ“¤...]
```

**SAGE DID κµ¬μ΅°**:

```
DID μμ‹:
did:sage:ethereum:0x742d35Cc6634C0532925a3b844Bc454e4438f44e

νμ‹± κ²°κ³Ό:
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ did           : DID ν‘μ¤€ ν”„λ΅ν† μ½            β”‚
β”‚ sage          : SAGE λ©”μ†λ“                 β”‚
β”‚ ethereum      : Ethereum λ„¤νΈμ›ν¬            β”‚
β”‚ 0x742d35Cc... : Ethereum μ£Όμ† (μ‹λ³„μ)       β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

λΈ”λ΅μ²΄μΈμ— μ €μ¥λ μ‹¤μ  λ°μ΄ν„°:
{
  "did": "did:sage:ethereum:0x742d35Cc...",
  "owner": "0x742d35Cc...",              // μ†μ μ μ£Όμ†
  "publicKey": "0x1234abcd...",          // Ed25519 κ³µκ°ν‚¤
  "name": "Trading Bot Alpha",           // μ—μ΄μ „νΈ μ΄λ¦„
  "description": "Automated trading",    // μ„¤λ…
  "endpoint": "https://bot.example.com", // API μ—”λ“ν¬μΈνΈ
  "capabilities": [                      // κΈ°λ¥ λ©λ΅
    "crypto-trading",
    "market-analysis",
    "risk-management"
  ],
  "active": true,                        // ν™μ„± μƒνƒ
  "createdAt": 1704067200,              // μƒμ„± νƒ€μ„μ¤νƒ¬ν”„
  "updatedAt": 1704153600               // μ—…λ°μ΄νΈ νƒ€μ„μ¤νƒ¬ν”„
}
```

### 4.2 HPKE (Hybrid Public Key Encryption)

**HPKEλ€?**

HPKEλ” κ³µκ°ν‚¤ μ•”νΈν™”μ™€ λ€μΉ­ν‚¤ μ•”νΈν™”μ μ¥μ μ„ κ²°ν•©ν• μµμ‹  μ•”νΈν™” ν‘μ¤€μ…λ‹λ‹¤ (RFC 9180).

**μ™ HybridμΈκ°€?**

```
κ³µκ°ν‚¤ μ•”νΈν™”λ§ μ‚¬μ©:
μ¥μ : ν‚¤ κµν™ μ•μ „
λ‹¨μ : λλ¦Ό (λ€μ©λ‰ λ°μ΄ν„° λ¶€μ ν•©)

λ€μΉ­ν‚¤ μ•”νΈν™”λ§ μ‚¬μ©:
μ¥μ : λ§¤μ° λΉ λ¦„
λ‹¨μ : ν‚¤λ¥Ό μ–΄λ–»κ² μ•μ „ν•κ² κ³µμ ?

HPKE (λ‘ κ°€μ§€ κ²°ν•©):
1. κ³µκ°ν‚¤ μ•”νΈν™”λ΅ λ€μΉ­ν‚¤ κ³µμ 
2. λ€μΉ­ν‚¤λ΅ μ‹¤μ  λ°μ΄ν„° μ•”νΈν™”
β†’ μ•μ „ν•λ©΄μ„λ„ λΉ λ¦„!
```

**SAGEμ—μ„μ HPKE μ‚¬μ©**:

```
ν•Έλ“μ…°μ΄ν¬ Request λ‹¨κ³„:

λ°μ‹ μ (Agent A):
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 1. μ„μ‹ X25519 ν‚¤ μ μƒμ„±             β”‚
β”‚    ephPrivA, ephPubA                 β”‚
β”‚                                      β”‚
β”‚ 2. Bμ κ³µκ°ν‚¤λ΅ HPKE μ„¤μ •             β”‚
β”‚    suite = KEM_X25519_HKDF_SHA256    β”‚
β”‚           + KDF_HKDF_SHA256          β”‚
β”‚           + AEAD_ChaCha20Poly1305    β”‚
β”‚                                      β”‚
β”‚ 3. μΊ΅μν™” (Encapsulation)            β”‚
β”‚    enc, ctx = Setup(B_pubKey)        β”‚
β”‚    - enc: μΊ΅μν™”λ ν‚¤ (32λ°”μ΄νΈ)      β”‚
β”‚    - ctx: μ•”νΈν™” μ»¨ν…μ¤νΈ             β”‚
β”‚                                      β”‚
β”‚ 4. λ©”μ‹μ§€ μ•”νΈν™”                      β”‚
β”‚    ciphertext = ctx.Seal(plaintext)  β”‚
β”‚                                      β”‚
β”‚ 5. ν¨ν‚· μƒμ„±                          β”‚
β”‚    packet = enc || ciphertext        β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
           β”‚
           β”‚ packet μ „μ†΅
           β†“
μμ‹ μ (Agent B):
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 1. ν¨ν‚· νμ‹±                          β”‚
β”‚    enc = packet[0:32]                β”‚
β”‚    ciphertext = packet[32:]          β”‚
β”‚                                      β”‚
β”‚ 2. μμ‹ μ κ°μΈν‚¤λ΅ HPKE μ„¤μ •          β”‚
β”‚    ctx = Setup(B_privKey, enc)       β”‚
β”‚                                      β”‚
β”‚ 3. λ³µνΈν™”                             β”‚
β”‚    plaintext = ctx.Open(ciphertext)  β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

μ½”λ“ μ„μΉ: crypto/keys/x25519.go:354-423
```

### 4.3 μ„Έμ… (Session)

**μ„Έμ…μ΄λ€?**

λ‘ μ—μ΄μ „νΈ κ°„μ λ³΄μ• ν†µμ‹  μ±„λ„μ„ μλ―Έν•λ©°, ν•Έλ“μ…°μ΄ν¬λ¥Ό ν†µν•΄ μƒμ„±λ©λ‹λ‹¤.

**μ„Έμ…μ μƒλ…μ£ΌκΈ°**:

```
1. μƒμ„± (Creation)
   β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
   β”‚ ν•Έλ“μ…°μ΄ν¬ μ™„λ£ μ‹:                  β”‚
   β”‚                                     β”‚
   β”‚ μ…λ ¥:                                β”‚
   β”‚ - κ³µμ  λΉ„λ°€ (sharedSecret)          β”‚
   β”‚ - μ»¨ν…μ¤νΈ ID (contextID)           β”‚
   β”‚ - μ„μ‹ κ³µκ°ν‚¤λ“¤ (ephA, ephB)         β”‚
   β”‚                                     β”‚
   β”‚ μ²λ¦¬:                                β”‚
   β”‚ 1. μ„Έμ… μ‹λ“ μ λ„:                   β”‚
   β”‚    salt = SHA256(label + ctx + ephs)β”‚
   β”‚    seed = HKDF-Extract(secret, salt)β”‚
   β”‚                                     β”‚
   β”‚ 2. μ„Έμ… ID κ³„μ‚°:                     β”‚
   β”‚    sid = Base64(SHA256(seed)[0:16]) β”‚
   β”‚                                     β”‚
   β”‚ 3. λ°©ν–¥λ³„ ν‚¤ μ λ„:                   β”‚
   β”‚    C2S_Enc = HKDF(seed, "c2s|enc")  β”‚
   β”‚    C2S_Sign = HKDF(seed, "c2s|sign")β”‚
   β”‚    S2C_Enc = HKDF(seed, "s2c|enc")  β”‚
   β”‚    S2C_Sign = HKDF(seed, "s2c|sign")β”‚
   β”‚                                     β”‚
   β”‚ μ¶λ ¥:                                β”‚
   β”‚ - SecureSession κ°μ²΄                β”‚
   β”‚ - μ„Έμ… ID                            β”‚
   β”‚ - μ•”νΈν™”/μ„λ… ν‚¤λ“¤                   β”‚
   β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

2. μ‚¬μ© (Usage)
   β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
   β”‚ λ©”μ‹μ§€ μ „μ†΅:                         β”‚
   β”‚ plaintext β†’ Encrypt β†’ ciphertext    β”‚
   β”‚                                     β”‚
   β”‚ μ„λ… μƒμ„±:                           β”‚
   β”‚ message β†’ HMAC-SHA256 β†’ signature   β”‚
   β”‚                                     β”‚
   β”‚ λ©”μ‹μ§€ μμ‹ :                         β”‚
   β”‚ ciphertext β†’ Decrypt β†’ plaintext    β”‚
   β”‚ signature β†’ Verify β†’ OK/FAIL        β”‚
   β”‚                                     β”‚
   β”‚ μƒνƒ μ—…λ°μ΄νΈ:                       β”‚
   β”‚ - lastUsedAt κ°±μ‹                    β”‚
   β”‚ - messageCount μ¦κ°€                 β”‚
   β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

3. λ§λ£ (Expiration)
   β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
   β”‚ λ§λ£ μ΅°κ±΄:                           β”‚
   β”‚                                     β”‚
   β”‚ 1. MaxAge μ΄κ³Ό                      β”‚
   β”‚    now > createdAt + MaxAge         β”‚
   β”‚    (μ: 1μ‹κ°„ ν›„ λ¬΄μ΅°κ±΄ λ§λ£)         β”‚
   β”‚                                     β”‚
   β”‚ 2. IdleTimeout μ΄κ³Ό                 β”‚
   β”‚    now > lastUsedAt + IdleTimeout   β”‚
   β”‚    (μ: 10λ¶„κ°„ μ‚¬μ© μ•ν•λ©΄ λ§λ£)      β”‚
   β”‚                                     β”‚
   β”‚ 3. MaxMessages μ΄κ³Ό                 β”‚
   β”‚    messageCount >= MaxMessages      β”‚
   β”‚    (μ: 10000κ° λ©”μ‹μ§€ ν›„ λ§λ£)      β”‚
   β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

4. μ •λ¦¬ (Cleanup)
   β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
   β”‚ Close() νΈμ¶ μ‹:                     β”‚
   β”‚                                     β”‚
   β”‚ 1. μƒνƒ ν”λκ·Έ μ„¤μ •                  β”‚
   β”‚    closed = true                    β”‚
   β”‚                                     β”‚
   β”‚ 2. ν‚¤ μ¬λ£ μ•μ „ μ‚­μ                  β”‚
   β”‚    for i in range(len(key)):        β”‚
   β”‚        key[i] = 0                   β”‚
   β”‚                                     β”‚
   β”‚ 3. λ€μƒ ν‚¤λ“¤:                        β”‚
   β”‚    - encryptKey                     β”‚
   β”‚    - signingKey                     β”‚
   β”‚    - sessionSeed                    β”‚
   β”‚    - outKey, inKey                  β”‚
   β”‚    - outSign, inSign                β”‚
   β”‚                                     β”‚
   β”‚ 4. λ§¤λ‹μ €μ—μ„ μ κ±°                   β”‚
   β”‚    manager.Remove(sessionID)        β”‚
   β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

μ½”λ“ μ„μΉ: session/session.go
```

### 4.4 RFC 9421 (HTTP Message Signatures)

**RFC 9421μ΄λ€?**

HTTP λ©”μ‹μ§€μ— λ””μ§€ν„Έ μ„λ…μ„ μ¶”κ°€ν•μ—¬ λ¬΄κ²°μ„±κ³Ό μ¶μ²λ¥Ό λ³΄μ¥ν•λ” ν‘μ¤€μ…λ‹λ‹¤.

**μ„λ… κ³Όμ • μƒμ„Έ μ„¤λ…**:

```
μμ‹ HTTP μ”μ²­:
POST /api/chat HTTP/1.1
Host: agent-b.example.com
Content-Type: application/json
Content-Length: 28

{"message": "Hello, Agent B"}

λ‹¨κ³„ 1: μ„λ…ν•  μ»΄ν¬λ„νΈ μ„ νƒ
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ μ„ νƒν• μ»΄ν¬λ„νΈλ“¤:                   β”‚
β”‚ - @method: POST                     β”‚
β”‚ - @authority: agent-b.example.com   β”‚
β”‚ - @path: /api/chat                  β”‚
β”‚ - content-type: application/json    β”‚
β”‚ - content-digest: SHA-256=...       β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

λ‹¨κ³„ 2: μ •κ·ν™” (Canonicalization)
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ "@method": POST                     β”‚
β”‚ "@authority": agent-b.example.com   β”‚
β”‚ "@path": /api/chat                  β”‚
β”‚ "content-type": application/json    β”‚
β”‚ "content-digest": sha-256=:...      β”‚
β”‚ "@signature-params": ("@method" ... β”‚
β”‚   );created=1704067200              β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
μ½”λ“ μ„μΉ: core/rfc9421/canonicalizer.go

λ‹¨κ³„ 3: μ„λ… μƒμ„±
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ signatureInput = [μ •κ·ν™”λ λ¬Έμμ—΄]    β”‚
β”‚                                     β”‚
β”‚ signature = Sign(                   β”‚
β”‚     privateKey,                     β”‚
β”‚     signatureInput                  β”‚
β”‚ )                                   β”‚
β”‚                                     β”‚
β”‚ signatureBase64 = Base64(signature) β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
μ½”λ“ μ„μΉ: core/rfc9421/verifier.go:72-75

λ‹¨κ³„ 4: ν—¤λ” μ¶”κ°€
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ Signature-Input: sig1=("@method" .. β”‚
β”‚   );created=1704067200;keyid="k1"  β”‚
β”‚                                     β”‚
β”‚ Signature: sig1=:signatureBase64:   β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

μµμΆ… HTTP μ”μ²­:
POST /api/chat HTTP/1.1
Host: agent-b.example.com
Content-Type: application/json
Content-Length: 28
Signature-Input: sig1=("@method" "@authority"
  "@path" "content-type" "content-digest");
  created=1704067200;keyid="agent-a-key-123"
Signature: sig1=:MEUCIQDx7+...base64...:

{"message": "Hello, Agent B"}
```

**μ„λ… κ²€μ¦ κ³Όμ •**:

```
μμ‹ μ (Agent B):

1. Signature ν—¤λ” νμ‹±
   β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
   β”‚ keyid μ¶”μ¶: "agent-a-key-123"   β”‚
   β”‚ algorithm μ¶”μ¶: "ed25519"       β”‚
   β”‚ signature μ¶”μ¶: [base64 λ””μ½”λ“] β”‚
   β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

2. KeyIDλ΅ μ„Έμ… μ΅°ν
   β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
   β”‚ session = manager.GetByKeyID(   β”‚
   β”‚     "agent-a-key-123"           β”‚
   β”‚ )                               β”‚
   β”‚                                 β”‚
   β”‚ μ„Έμ…μ—μ„ κ²€μ¦ ν‚¤ κ°€μ Έμ¤κΈ°:        β”‚
   β”‚ verifyKey = session.inSign      β”‚
   β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

3. μ„λ… λ² μ΄μ¤ μ¬κµ¬μ„±
   β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
   β”‚ Signature-Inputμ— λ…μ‹λ         β”‚
   β”‚ μ»΄ν¬λ„νΈλ“¤μ„ κ°™μ€ λ°©μ‹μΌλ΅ μ •κ·ν™”  β”‚
   β”‚                                 β”‚
   β”‚ reconstructed = Canonicalize(   β”‚
   β”‚     request,                    β”‚
   β”‚     ["@method", "@authority"...]β”‚
   β”‚ )                               β”‚
   β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

4. μ„λ… κ²€μ¦
   β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
   β”‚ valid = Verify(                 β”‚
   β”‚     verifyKey,                  β”‚
   β”‚     reconstructed,              β”‚
   β”‚     signature                   β”‚
   β”‚ )                               β”‚
   β”‚                                 β”‚
   β”‚ if !valid:                      β”‚
   β”‚     return ERROR                β”‚
   β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

5. μ¶”κ°€ κ²€μ¦
   β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
   β”‚ - Timestamp ν™•μΈ                β”‚
   β”‚   now - created < MaxSkew       β”‚
   β”‚                                 β”‚
   β”‚ - Nonce ν™•μΈ (μ¬μƒ κ³µκ²© λ°©μ§€)    β”‚
   β”‚   !nonces.Seen(nonce)           β”‚
   β”‚                                 β”‚
   β”‚ - μ„Έμ… λ§λ£ ν™•μΈ                 β”‚
   β”‚   !session.IsExpired()          β”‚
   β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

μ½”λ“ μ„μΉ: core/rfc9421/verifier.go:46-70
```

---

## 5. ν”„λ΅μ νΈ κµ¬μ΅° μƒμ„Έ λ¶„μ„

### 5.1 λ””λ ‰ν† λ¦¬ κµ¬μ΅°

```
sage/
β”β”€β”€ cmd/                      # μ‹¤ν–‰ κ°€λ¥ν• CLI λ„κµ¬λ“¤
β”‚   β”β”€β”€ sage-crypto/         # μ•”νΈν™” ν‚¤ κ΄€λ¦¬ CLI
β”‚   β”‚   β”β”€β”€ main.go          # μ§„μ…μ 
β”‚   β”‚   β”β”€β”€ generate.go      # ν‚¤ μƒμ„± λ…λ Ήμ–΄
β”‚   β”‚   β”β”€β”€ sign.go          # μ„λ… λ…λ Ήμ–΄
β”‚   β”‚   β”β”€β”€ verify.go        # κ²€μ¦ λ…λ Ήμ–΄
β”‚   β”‚   β””β”€β”€ ...
β”‚   β”‚
β”‚   β”β”€β”€ sage-did/            # DID κ΄€λ¦¬ CLI
β”‚   β”‚   β”β”€β”€ main.go          # μ§„μ…μ 
β”‚   β”‚   β”β”€β”€ register.go      # DID λ“±λ΅
β”‚   β”‚   β”β”€β”€ resolve.go       # DID μ΅°ν
β”‚   β”‚   β”β”€β”€ update.go        # DID μ—…λ°μ΄νΈ
β”‚   β”‚   β””β”€β”€ ...
β”‚   β”‚
β”‚   β””β”€β”€ sage-verify/         # λ©”μ‹μ§€ κ²€μ¦ CLI
β”‚       β””β”€β”€ main.go
β”‚
β”β”€β”€ core/                    # ν•µμ‹¬ ν”„λ΅ν† μ½ κµ¬ν„
β”‚   β”β”€β”€ rfc9421/            # RFC 9421 HTTP μ„λ…
β”‚   β”‚   β”β”€β”€ canonicalizer.go # λ©”μ‹μ§€ μ •κ·ν™”
β”‚   β”‚   β”β”€β”€ verifier.go      # μ„λ… μƒμ„±/κ²€μ¦
β”‚   β”‚   β”β”€β”€ parser.go        # μ„λ… ν—¤λ” νμ‹±
β”‚   β”‚   β””β”€β”€ types.go         # λ°μ΄ν„° κµ¬μ΅°
β”‚   β”‚
β”‚   β””β”€β”€ message/            # λ©”μ‹μ§€ μ²λ¦¬
β”‚       β”β”€β”€ validator/       # λ©”μ‹μ§€ κ²€μ¦
β”‚       β”β”€β”€ order/          # λ©”μ‹μ§€ μμ„ κ΄€λ¦¬
β”‚       β”β”€β”€ nonce/          # Nonce κ΄€λ¦¬
β”‚       β””β”€β”€ dedupe/         # μ¤‘λ³µ μ κ±°
β”‚
β”β”€β”€ crypto/                  # μ•”νΈν™” λ¨λ“
β”‚   β”β”€β”€ keys/               # ν‚¤ μ κµ¬ν„
β”‚   β”‚   β”β”€β”€ ed25519.go      # Ed25519 μ„λ… ν‚¤
β”‚   β”‚   β”β”€β”€ secp256k1.go    # Ethereum νΈν™ ν‚¤
β”‚   β”‚   β”β”€β”€ x25519.go       # ν‚¤ κµν™μ©
β”‚   β”‚   β””β”€β”€ constructors.go # ν©ν† λ¦¬ ν•¨μλ“¤
β”‚   β”‚
β”‚   β”β”€β”€ chain/              # λΈ”λ΅μ²΄μΈλ³„ μ•”νΈν™”
β”‚   β”‚   β”β”€β”€ ethereum/       # Ethereum κµ¬ν„
β”‚   β”‚   β””β”€β”€ solana/         # Solana κµ¬ν„
β”‚   β”‚
β”‚   β”β”€β”€ storage/            # ν‚¤ μ €μ¥μ†
β”‚   β”‚   β”β”€β”€ file.go         # νμΌ κΈ°λ°
β”‚   β”‚   β””β”€β”€ memory.go       # λ©”λ¨λ¦¬ κΈ°λ°
β”‚   β”‚
β”‚   β”β”€β”€ vault/              # ν•λ“μ›¨μ–΄ λ³΄μ•
β”‚   β”‚   β””β”€β”€ secure_storage.go # OS ν‚¤μ²΄μΈ ν†µν•©
β”‚   β”‚
β”‚   β””β”€β”€ formats/            # ν‚¤ ν¬λ§· λ³€ν™
β”‚       β”β”€β”€ jwk.go          # JSON Web Key
β”‚       β””β”€β”€ pem.go          # PEM ν¬λ§·
β”‚
β”β”€β”€ did/                     # νƒμ¤‘μ•™ν™” μ‹ μ›
β”‚   β”β”€β”€ manager.go          # DID ν†µν•© κ΄€λ¦¬μ
β”‚   β”β”€β”€ resolver.go         # DID λ¬Έμ„ μ΅°ν
β”‚   β”β”€β”€ registry.go         # DID λ“±λ΅/μ—…λ°μ΄νΈ
β”‚   β”β”€β”€ verification.go     # DID κ²€μ¦
β”‚   β”‚
β”‚   β”β”€β”€ ethereum/           # Ethereum DID ν΄λΌμ΄μ–ΈνΈ
β”‚   β”‚   β”β”€β”€ client.go       # μ¤λ§νΈ μ»¨νΈλ™νΈ μƒνΈμ‘μ©
β”‚   β”‚   β”β”€β”€ resolver.go     # Ethereum DID μ΅°ν
β”‚   β”‚   β””β”€β”€ abi.go          # μ»¨νΈλ™νΈ ABI λ°”μΈλ”©
β”‚   β”‚
β”‚   β””β”€β”€ solana/             # Solana DID ν΄λΌμ΄μ–ΈνΈ
β”‚       β”β”€β”€ client.go
β”‚       β””β”€β”€ resolver.go
β”‚
β”β”€β”€ handshake/               # λ³΄μ• ν•Έλ“μ…°μ΄ν¬
β”‚   β”β”€β”€ client.go           # μ”μ²­ μΈ΅ κµ¬ν„
β”‚   β”β”€β”€ server.go           # μ‘λ‹µ μΈ΅ κµ¬ν„
β”‚   β”β”€β”€ types.go            # λ©”μ‹μ§€ νƒ€μ…λ“¤
β”‚   β””β”€β”€ utils.go            # μ ν‹Έλ¦¬ν‹° ν•¨μ
β”‚
β”β”€β”€ session/                 # μ„Έμ… κ΄€λ¦¬
β”‚   β”β”€β”€ manager.go          # μ„Έμ… μƒλ…μ£ΌκΈ° κ΄€λ¦¬
β”‚   β”β”€β”€ session.go          # SecureSession κµ¬ν„
β”‚   β”β”€β”€ nonce.go            # μ¬μƒ κ³µκ²© λ°©μ§€
β”‚   β”β”€β”€ metadata.go         # μ„Έμ… λ©”νƒ€λ°μ΄ν„°
β”‚   β””β”€β”€ types.go            # μΈν„°νμ΄μ¤ μ •μ
β”‚
β”β”€β”€ hpke/                    # HPKE μ•”νΈν™”
β”‚   β”β”€β”€ client.go           # μ†΅μ‹ μ (Sender)
β”‚   β”β”€β”€ server.go           # μμ‹ μ (Receiver)
β”‚   β””β”€β”€ common.go           # κ³µν†µ μ ν‹Έλ¦¬ν‹°
β”‚
β”β”€β”€ contracts/               # μ¤λ§νΈ μ»¨νΈλ™νΈ
β”‚   β””β”€β”€ ethereum/
β”‚       β”β”€β”€ contracts/       # Solidity μ†μ¤μ½”λ“
β”‚       β”‚   β”β”€β”€ SageRegistryV2.sol  # V2 λ μ§€μ¤νΈλ¦¬
β”‚       β”‚   β”β”€β”€ interfaces/         # μΈν„°νμ΄μ¤λ“¤
β”‚       β”‚   β””β”€β”€ test/              # ν…μ¤νΈ μ»¨νΈλ™νΈ
β”‚       β”‚
β”‚       β”β”€β”€ scripts/         # λ°°ν¬ μ¤ν¬λ¦½νΈ
β”‚       β”‚   β”β”€β”€ deploy.js
β”‚       β”‚   β””β”€β”€ verify.js
β”‚       β”‚
β”‚       β””β”€β”€ test/            # Hardhat ν…μ¤νΈ
β”‚           β””β”€β”€ SageRegistryV2.test.js
β”‚
β”β”€β”€ config/                  # μ„¤μ • κ΄€λ¦¬
β”‚   β”β”€β”€ config.go           # ν†µν•© μ„¤μ • λ΅λ”
β”‚   β”β”€β”€ blockchain.go       # λΈ”λ΅μ²΄μΈ μ„¤μ •
β”‚   β””β”€β”€ validator.go        # μ„¤μ • κ²€μ¦
β”‚
β”β”€β”€ health/                  # ν—¬μ¤ μ²΄ν¬
β”‚   β”β”€β”€ checker.go          # μ»΄ν¬λ„νΈ μƒνƒ ν™•μΈ
β”‚   β””β”€β”€ server.go           # HTTP μ—”λ“ν¬μΈνΈ
β”‚
β”β”€β”€ examples/                # μ‚¬μ© μμ 
β”‚   β””β”€β”€ mcp-integration/    # MCP ν†µν•© μμ 
β”‚       β”β”€β”€ basic-demo/     # κΈ°λ³Έ λ°λ¨
β”‚       β”β”€β”€ basic-tool/     # λ„κµ¬ ν†µν•©
β”‚       β””β”€β”€ vulnerable-vs-secure/  # λ³΄μ• λΉ„κµ
β”‚
β”β”€β”€ tests/                   # ν…μ¤νΈ μ½”λ“
β”‚   β”β”€β”€ integration/        # ν†µν•© ν…μ¤νΈ
β”‚   β”β”€β”€ random/             # λ¬΄μ‘μ„ ν…μ¤νΈ
β”‚   β””β”€β”€ handshake/          # ν•Έλ“μ…°μ΄ν¬ ν…μ¤νΈ
β”‚
β”β”€β”€ docs/                    # λ¬Έμ„
β”‚   β”β”€β”€ handshake/          # ν•Έλ“μ…°μ΄ν¬ λ¬Έμ„
β”‚   β”β”€β”€ dev/                # κ°λ°μ κ°€μ΄λ“
β”‚   β””β”€β”€ assets/             # λ‹¤μ΄μ–΄κ·Έλ¨ λ“±
β”‚
β”β”€β”€ scripts/                 # μ ν‹Έλ¦¬ν‹° μ¤ν¬λ¦½νΈ
β”‚   β””β”€β”€ deploy-sage.sh      # λ°°ν¬ μ¤ν¬λ¦½νΈ
β”‚
β””β”€β”€ internal/                # λ‚΄λ¶€ μ ν‹Έλ¦¬ν‹°
    β””β”€β”€ utils/
```

### 5.2 μ£Όμ” νμΌ μ„¤λ…

#### 5.2.1 μ•”νΈν™” ν‚¤ κ΄€λ¦¬

**crypto/keys/ed25519.go** (87μ¤„)
```go
// Ed25519 ν‚¤ μ κµ¬μ΅°μ²΄
type ed25519KeyPair struct {
    privateKey ed25519.PrivateKey  // 64λ°”μ΄νΈ
    publicKey  ed25519.PublicKey   // 32λ°”μ΄νΈ
    id         string               // 16μ§„μ μ‹λ³„μ
}

// ν•µμ‹¬ κΈ°λ¥:
1. GenerateEd25519KeyPair()
   - μ•”νΈν•™μ μΌλ΅ μ•μ „ν• λ‚μ μƒμ„±κΈ° μ‚¬μ©
   - κ³µκ°ν‚¤ ν•΄μ‹μ μ²« 8λ°”μ΄νΈλ΅ ID μƒμ„±

2. Sign(message []byte)
   - λ©”μ‹μ§€μ— λ€ν• 64λ°”μ΄νΈ μ„λ… μƒμ„±
   - κ²°μ •λ΅ μ  (κ°™μ€ λ©”μ‹μ§€ = κ°™μ€ μ„λ…)

3. Verify(message, signature []byte)
   - κ³µκ°ν‚¤λ΅ μ„λ… κ²€μ¦
   - O(1) μ‹κ°„ λ³µμ΅λ„

μ„μΉ: /crypto/keys/ed25519.go:1-88
```

**crypto/keys/x25519.go** (550μ¤„)
```go
// X25519 ν‚¤ μ κµ¬μ΅°μ²΄
type X25519KeyPair struct {
    privateKey *ecdh.PrivateKey  // 32λ°”μ΄νΈ
    publicKey  *ecdh.PublicKey   // 32λ°”μ΄νΈ
    id         string
}

// ν•µμ‹¬ κΈ°λ¥:
1. DeriveSharedSecret(peerPubBytes []byte)
   - ECDHλ΅ κ³µμ  λΉ„λ°€ κ³„μ‚°
   - SHA-256 ν•΄μ‹±

2. EncryptWithEd25519Peer(edPeerPub, plaintext)
   - Ed25519 ν‚¤λ¥Ό X25519λ΅ λ³€ν™
   - HKDFλ΅ ν‚¤ μ λ„
   - AES-256-GCMμΌλ΅ μ•”νΈν™”

3. DecryptWithEd25519Peer(privateKey, packet)
   - μ—­κ³Όμ •μΌλ΅ λ³µνΈν™”

4. HPKE ν—¬νΌ ν•¨μλ“¤:
   - HPKEDeriveSharedSecretToX25519Peer()
   - HPKEOpenSharedSecretWithX25519Priv()
   - HPKESealAndExportToX25519Peer()

μ„μΉ: /crypto/keys/x25519.go:1-550
```

#### 5.2.2 ν•Έλ“μ…°μ΄ν¬ κµ¬ν„

**handshake/client.go** (152μ¤„)
```go
// ν΄λΌμ΄μ–ΈνΈ (μ”μ²­ μΈ΅) κµ¬μ΅°μ²΄
type Client struct {
    a2a.A2AServiceClient  // gRPC ν΄λΌμ΄μ–ΈνΈ
    key sagecrypto.KeyPair // Ed25519 ν‚¤
}

// 4λ‹¨κ³„ ν•Έλ“μ…°μ΄ν¬ λ©”μ„λ“:

1. Invitation(ctx, invMsg, did)
   - λ…ν™•ν• ν…μ¤νΈλ΅ μ΄λ€ μ „μ†΅
   - Ed25519λ΅ μ„λ…
   - A2A ν”„λ΅ν† μ½ λ©”μ‹μ§€λ΅ λν•‘

2. Request(ctx, reqMsg, edPeerPub, did)
   - X25519 μ„μ‹ κ³µκ°ν‚¤ ν¬ν•¨
   - ν”Όμ–΄μ Ed25519 ν‚¤λ΅ μ•”νΈν™”
   - Base64 μΈμ½”λ”© ν›„ μ „μ†΅

3. Complete(ctx, compMsg, did)
   - ν•Έλ“μ…°μ΄ν¬ μ™„λ£ μ•λ¦Ό
   - KeyID μμ‹  λ€κΈ°

μ„μΉ: /handshake/client.go:1-152
```

**handshake/server.go** (519μ¤„)
```go
// μ„λ²„ (μ‘λ‹µ μΈ΅) κµ¬μ΅°μ²΄
type Server struct {
    key      sagecrypto.KeyPair
    events   Events              // μ΄λ²¤νΈ ν•Έλ“¤λ¬
    resolver did.Resolver        // DID μ΅°ν
    pending  map[string]pendingState  // μ„μ‹ μƒνƒ
    peers    map[string]cachedPeer    // ν”Όμ–΄ μΊμ‹
}

// ν•µμ‹¬ λ©”μ„λ“:

1. SendMessage(ctx, in *a2a.SendMessageRequest)
   - λ¨λ“  ν•Έλ“μ…°μ΄ν¬ λ‹¨κ³„μ μ§„μ…μ 
   - Phase νμ‹± λ° λΌμ°ν…

2. Invitation μ²λ¦¬:
   - DID κ²€μ¦ (λΈ”λ΅μ²΄μΈ μ΅°ν)
   - μ„λ… κ²€μ¦
   - OnInvitation μ΄λ²¤νΈ λ°μƒ

3. Request μ²λ¦¬:
   - μ•”νΈν™”λ νμ΄λ΅λ“ λ³µνΈν™”
   - ν”Όμ–΄ μ„μ‹ ν‚¤ μ €μ¥
   - μμ‹ μ μ„μ‹ ν‚¤ μƒμ„±
   - Response μ „μ†΅

4. Complete μ²λ¦¬:
   - μ„Έμ… νλΌλ―Έν„° κµ¬μ„±
   - OnComplete μ΄λ²¤νΈ λ°μƒ
   - KeyID λ°κΈ‰ λ° λ°ν™

5. cleanupLoop():
   - λ°±κ·ΈλΌμ΄λ“μ—μ„ μ‹¤ν–‰
   - λ§λ£λ pending μƒνƒ μ •λ¦¬
   - ν”Όμ–΄ μΊμ‹ μ •λ¦¬

μ„μΉ: /handshake/server.go:1-519
```

#### 5.2.3 μ„Έμ… κ΄€λ¦¬

**session/session.go** (664μ¤„)
```go
// λ³΄μ• μ„Έμ… κµ¬μ΅°μ²΄
type SecureSession struct {
    id           string
    createdAt    time.Time
    lastUsedAt   time.Time
    messageCount int
    config       Config
    closed       bool

    // μ—­ν•  (initiator = trueλ©΄ ν΄λΌμ΄μ–ΈνΈ)
    initiator    bool

    // μ•”νΈν™” μ¬λ£
    sessionSeed  []byte     // HKDF PRK
    encryptKey   []byte     // λ‹¨μΌ λ°©ν–¥μ©
    signingKey   []byte

    // λ°©ν–¥λ³„ ν‚¤
    outKey       []byte     // μ†΅μ‹  μ•”νΈν™”
    inKey        []byte     // μμ‹  μ•”νΈν™”
    outSign      []byte     // μ†΅μ‹  μ„λ…
    inSign       []byte     // μμ‹  μ„λ…

    // AEAD μΈμ¤ν„΄μ¤
    aead         cipher.AEAD    // λ κ±°μ‹
    aeadOut      cipher.AEAD    // μ†΅μ‹ μ©
    aeadIn       cipher.AEAD    // μμ‹ μ©
}

// ν•µμ‹¬ ν•¨μ:

1. NewSecureSessionFromExporterWithRole()
   - HPKE μµμ¤ν¬ν„° λΉ„λ°€μ—μ„ μ„Έμ… μƒμ„±
   - initiatorμ— λ”°λΌ ν‚¤ λ°©ν–¥ κ²°μ •

2. DeriveSessionSeed()
   - HKDF-Extractλ΅ PRK μƒμ„±
   - Salt = SHA256(label + contextID + ephKeys)

3. ComputeSessionIDFromSeed()
   - κ²°μ •λ΅ μ  μ„Έμ… ID μƒμ„±
   - Base64(SHA256(seed)[0:16])

4. deriveDirectionalKeys()
   - c2s (client-to-server) ν‚¤ μ λ„
   - s2c (server-to-client) ν‚¤ μ λ„
   - κ°κ° μ•”νΈν™” ν‚¤ + μ„λ… ν‚¤

5. EncryptOutbound() / DecryptInbound()
   - ChaCha20-Poly1305 μ‚¬μ©
   - Nonce (12λ°”μ΄νΈ) + Ciphertext

6. Close()
   - λ¨λ“  ν‚¤ λ©”λ¨λ¦¬λ¥Ό 0μΌλ΅ λ®μ–΄μ“°κΈ°
   - λ³΄μ• μ‚­μ 

μ„μΉ: /session/session.go:1-664
```

**session/manager.go**
```go
// μ„Έμ… κ΄€λ¦¬μ
type Manager struct {
    sessions map[string]*SecureSession  // sessionID -> Session
    keyIDs   map[string]string         // keyID -> sessionID
    mu       sync.RWMutex
    config   Config
}

// ν•µμ‹¬ κΈ°λ¥:

1. CreateSession()
   - μƒ μ„Έμ… μƒμ„± λ° λ“±λ΅
   - κ³ μ  ID ν• λ‹Ή

2. BindKeyID()
   - KeyIDλ¥Ό μ„Έμ… IDμ— λ°”μΈλ”©
   - RFC 9421 μ„λ…μ— μ‚¬μ©

3. GetByKeyID()
   - KeyIDλ΅ μ„Έμ… μ΅°ν
   - μ„λ… κ²€μ¦ μ‹ μ‚¬μ©

4. CleanupExpired()
   - μ£ΌκΈ°μ μΌλ΅ λ§λ£ μ„Έμ… μ κ±°
   - λ©”λ¨λ¦¬ κ΄€λ¦¬

μ„μΉ: /session/manager.go
```

### 5.3 λ°μ΄ν„° νλ¦„ μ”μ•½

```
μ™„μ „ν• ν†µμ‹  ν”λ΅μ°:

1. μ΄κΈ°ν™”
   β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
   β”‚ Agent A                              β”‚
   β”‚ - Ed25519 ν‚¤ λ΅λ“                    β”‚
   β”‚ - DID μ„¤μ •                           β”‚
   β”‚ - gRPC μ—°κ²° μλ¦½                     β”‚
   β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

2. DID μ΅°ν
   β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
   β”‚ A β†’ Ethereum: getAgent(Bμ μ£Όμ†)     β”‚
   β”‚ Ethereum β†’ A: Bμ λ©”νƒ€λ°μ΄ν„°          β”‚
   β”‚   - κ³µκ°ν‚¤                            β”‚
   β”‚   - μ—”λ“ν¬μΈνΈ                        β”‚
   β”‚   - κΈ°λ¥                              β”‚
   β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

3. ν•Έλ“μ…°μ΄ν¬ (4λ‹¨κ³„)
   [μƒμ„Έλ” Part 4μ—μ„ λ‹¤λ£Έ]

4. λ³΄μ• ν†µμ‹ 
   β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
   β”‚ A: λ©”μ‹μ§€ μ‘μ„±                        β”‚
   β”‚ β†“                                    β”‚
   β”‚ A: μ„Έμ… ν‚¤λ΅ μ•”νΈν™”                   β”‚
   β”‚ β†“                                    β”‚
   β”‚ A: RFC 9421 μ„λ… μƒμ„±                β”‚
   β”‚ β†“                                    β”‚
   β”‚ A β†’ B: μ•”νΈν™”λ λ©”μ‹μ§€ + μ„λ…          β”‚
   β”‚ β†“                                    β”‚
   β”‚ B: μ„λ… κ²€μ¦                          β”‚
   β”‚ β†“                                    β”‚
   β”‚ B: λ³µνΈν™”                             β”‚
   β”‚ β†“                                    β”‚
   β”‚ B: λ©”μ‹μ§€ μ²λ¦¬                        β”‚
   β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

5. μ„Έμ… μΆ…λ£
   β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
   β”‚ μ΅°κ±΄ μ²΄ν¬:                            β”‚
   β”‚ - MaxAge μ΄κ³Ό?                       β”‚
   β”‚ - IdleTimeout μ΄κ³Ό?                  β”‚
   β”‚ - MaxMessages μ΄κ³Ό?                  β”‚
   β”‚ β†“                                    β”‚
   β”‚ YES: μ„Έμ… μ •λ¦¬                        β”‚
   β”‚ - λ¨λ“  ν‚¤ μ‚­μ                         β”‚
   β”‚ - λ§¤λ‹μ €μ—μ„ μ κ±°                     β”‚
   β”‚ - λ¦¬μ†μ¤ ν•΄μ                          β”‚
   β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

---

## λ‹¤μ ννΈ μκ³ 

**Part 2: μ•”νΈν™” μ‹μ¤ν… Deep Dive**μ—μ„λ” λ‹¤μ λ‚΄μ©μ„ λ‹¤λ£Ήλ‹λ‹¤:

1. Ed25519, Secp256k1, X25519μ μν•™μ  μ›λ¦¬
2. HPKEμ λ‚΄λ¶€ λ™μ‘ μ›λ¦¬
3. ChaCha20-Poly1305 AEAD μ•”νΈν™”
4. HKDF ν‚¤ μ λ„ ν•¨μ μƒμ„Έ
5. ν‚¤ λ³€ν™ κ³Όμ • (Ed25519 β†” X25519)
6. μ‹¤μ  μ½”λ“ μμ μ™€ ν…μ¤νΈ

**Part 3: DID λ° λΈ”λ΅μ²΄μΈ ν†µν•©**μ—μ„λ”:
1. Ethereum μ¤λ§νΈ μ»¨νΈλ™νΈ μƒμ„Έ λ¶„μ„
2. μ¨μ²΄μΈ λ°μ΄ν„° κµ¬μ΅°
3. κ°€μ¤ μµμ ν™” κΈ°λ²•
4. λ‹¤μ¤‘ μ²΄μΈ μ§€μ› κµ¬ν„
5. DID μ΅°ν λ° μΊμ‹± μ „λµ

κ³„μ†ν•΄μ„ Part 2λ¥Ό μ‘μ„±ν•μ‹κ² μµλ‹κΉ?
